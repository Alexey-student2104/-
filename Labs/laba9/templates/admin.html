{% extends "base.html" %}

{% block title %}Админ-панель{% endblock %}

{% block content %}
<h1>Админ-панель</h1>

<div class="admin-sections">
    <div class="admin-section">
        <h2>Управление пользователями</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя пользователя</th>
                    <th>Пароль (хеш)</th>
                    <th>Статус</th>
                    <th>Подписок</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.password }}</td>
                    <td>
                        {% if user.is_admin %}
                        <span class="admin-badge">Администратор</span>
                        {% else %}
                        <span class="user-badge">Пользователь</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.currencies %}
                        {{ user.currencies|length }}
                        {% else %}
                        0
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('user', id=user.id) }}" class="btn-view">Профиль</a>
                        <a href="{{ url_for('view_user_subscriptions', user_id=user.id) }}" 
                           class="btn-subscriptions">Подписки</a>
                        <a href="{{ url_for('admin_delete_user', user_id=user.id) }}" 
                           class="btn-delete"
                           onclick="return confirm('Удалить пользователя?')">Удалить</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="admin-section">
        <h2>Добавить новую валюту</h2>
        <form method="POST" action="{{ url_for('admin_add_currency') }}" class="add-currency-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="num_code">NumCode:</label>
                    <input type="text" id="num_code" name="num_code" required>
                </div>
                
                <div class="form-group">
                    <label for="char_code">CharCode:</label>
                    <input type="text" id="char_code" name="char_code" required maxlength="3">
                </div>
            </div>
            
            <div class="form-group">
                <label for="name">Название:</label>
                <input type="text" id="name" name="name" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="value">Курс:</label>
                    <input type="number" id="value" name="value" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="nominal">Номинал:</label>
                    <input type="number" id="nominal" name="nominal" required>
                </div>
            </div>
            
            <button type="submit" class="btn-submit">Добавить валюту</button>
        </form>
    </div>
    
    <div class="admin-section">
        <h2>Управление подписками</h2>
        <div class="admin-actions">
            <a href="{{ url_for('generate_test_subscriptions') }}" 
               class="btn-submit"
               onclick="return confirm('Создать тестовые подписки для всех пользователей?')">
                Создать тестовые подписки
            </a>
            <a href="{{ url_for('subscriptions_statistics') }}" 
               class="btn-view">
                Статистика подписок
            </a>
            <p class="admin-hint">
                Создает разные подписки для каждого пользователя
            </p>
        </div>
    </div>
    
    <div class="admin-section">
        <h2>Опасные операции</h2>
        <div class="danger-actions">
            <a href="{{ url_for('reset_database') }}" 
               class="btn-delete"
               onclick="return confirm('ВНИМАНИЕ! Это удалит все данные и сбросит базу к начальному состоянию. Продолжить?')">
               Сбросить всю базу данных
            </a>
            <p class="danger-hint">
                ⚠️ Все пользователи, валюты и настройки будут удалены!
            </p>
        </div>
    </div>
    
    <div class="admin-section">
        <h2>Текущие валюты (всего: {{ currencies|length }})</h2>
        <div class="currency-actions">
            <a href="{{ url_for('fetch_currencies') }}" class="btn-submit">Загрузить с ЦБ РФ</a>
            <a href="{{ url_for('show_currencies') }}" class="btn-view" target="_blank">Показать в консоли</a>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>CharCode</th>
                    <th>Название</th>
                    <th>Курс</th>
                    <th>Номинал</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for currency in currencies %}
                <tr>
                    <td>{{ currency.id }}</td>
                    <td>{{ currency.char_code }}</td>
                    <td>{{ currency.name }}</td>
                    <td>{{ "%.2f"|format(currency.value) }} ₽</td>
                    <td>{{ currency.nominal }}</td>
                    <td>
                        <a href="{{ url_for('delete_currency_route', id=currency.id) }}" 
                           class="btn-delete"
                           onclick="return confirm('Удалить валюту?')">Удалить</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}